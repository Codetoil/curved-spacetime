# modified from https://theawesomegarage.com/blog/automating-relases-with-github-actions

name: Create Debug Release
on:
  push:
    branches:
      - master

env:
  VERSION: 0.1.0-SNAPSHOT

permissions:
  contents: write

jobs:
  create-debug-release:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Resolve true commit SHA
        id: sha_resolver
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            ACTUAL_SHA=$(git log --merges --pretty=format:%H -1 | xargs -I{} git show {} --no-patch --format=%P | cut -d' ' -f2)
            echo "TRUE_SHA=${ACTUAL_SHA:-${{ github.sha }}}" >> $GITHUB_OUTPUT
          else
            echo "TRUE_SHA=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Get PR metadata
        uses: 8BitJonny/gh-get-current-pr@4.0.0
        id: pr_meta
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sha: ${{ steps.sha_resolver.outputs.TRUE_SHA }}

      - name: Check if PR was squashed
        id: check_squash
        run: |
          # Fetch PR commits using GitHub API and count them using Python
          PR_COMMITS=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ steps.pr_meta.outputs.number }}/commits" | \
            python3 -c "import sys, json; print(len(json.load(sys.stdin)))")

          echo "Commit count: $PR_COMMITS"

          # If there's only one commit, assume it's a squash merge
          if [[ "$PR_COMMITS" -eq 1 ]]; then
            echo "SQUASH_MERGE=true" >> $GITHUB_ENV
          else
            echo "SQUASH_MERGE=false" >> $GITHUB_ENV
          fi

      - name: Get commit messages with SHAs
        run: |
          if [[ "$SQUASH_MERGE" == "true" ]]; then
            # For squash merges, just fetch the single PR commit
            response=$(curl -s \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/${{ steps.pr_meta.outputs.number }}/commits")

            echo "$response" \
              | python3 -c "import sys, json; d = json.load(sys.stdin)[0]; print(f\"{d['commit']['message']} ({d['sha'][:7]})\")" \
              > commits.txt
          else
            # For regular merges, exclude lines containing "Merge pull request"
            git log --pretty=format:"%s (%h)" ${{ github.event.before }}..${{ github.sha }} \
              | grep -v "Merge pull request" \
              > commits.txt
          fi

      - name: Build release notes file
        run: |
          # Create a file for the release notes.
          # Title from the PR:
          echo "## ${{ steps.pr_meta.outputs.pr_title }}" > release_body.md

          # Conditionally add a "Summary" section if there's a PR body.
          if [[ -n "${{ steps.pr_meta.outputs.pr_body }}" ]]; then
            echo "" >> release_body.md
            echo "### Summary" >> release_body.md
            echo "${{ steps.pr_meta.outputs.pr_body }}" >> release_body.md
          fi

          echo "" >> release_body.md
          echo "### Changes" >> release_body.md
          awk '{print "â€¢ " $0}' commits.txt >> release_body.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.VERSION }}-${{ github.sha }}
          name: "Debug Release ${{ env.VERSION }}-${{ github.sha }}"
          body_path: release_body.md
          draft: true
          prerelease: true